<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Social Impression Rating Task</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.4"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        
        .rating-container {
            text-align: center;
            margin-top: 30px;
        }
        
        .rating-scale {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin: 20px auto;
            max-width: 700px;
        }
        
        .rating-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
        }
        
        .rating-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .rating-label {
            font-size: 14px;
            text-align: center;
            max-width: 80px;
        }
        
        .question-text {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .slider-container {
            margin: 30px auto;
            max-width: 600px;
            text-align: center;
        }
        
        .slider-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .slider {
            width: 500px;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            outline: none;
            border-radius: 5px;
            margin: 0 20px;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
        }
        
        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            background: #4CAF50;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        
        .slider-value {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            min-width: 30px;
        }
        
        .warning-message {
            color: red;
            font-size: 18px;
            font-weight: bold;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
        
        .validation-warning {
            color: red;
            font-size: 18px;
            font-weight: bold;
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
        
        .stimulus-image {
            max-width: 180px;
            max-height: 220px;
            object-fit: contain;
            display: block;
            margin: 20px auto;
        }
        
        .bio-text {
            max-width: 800px;
            margin: 20px auto;
            text-align: left;
            font-size: 16px;
            line-height: 1.6;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
        }
        
        .dual-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .attention-check {
            font-size: 20px;
            margin: 40px auto;
            max-width: 600px;
            text-align: center;
            padding: 30px;
            background-color: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
        }
        
        .fixation {
            font-size: 60px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        
        .stimulus-with-rating {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        .rating-option.selected {
            background-color: #4CAF50;
            border-radius: 5px;
            padding: 5px;
        }
        
        .rating-option.selected .rating-number {
            color: white;
        }
        
        .submit-prompt {
            margin-top: 20px;
            font-size: 16px;
            font-style: italic;
            color: #666;
        }
        
        .candidate-name {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        
        .familiarity-buttons {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 20px 0;
        }
        
        .familiarity-button {
            padding: 15px 40px;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #4CAF50;
            background-color: white;
            color: #4CAF50;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .familiarity-button:hover {
            background-color: #e8f5e9;
        }
        
        .familiarity-button.selected {
            background-color: #4CAF50;
            color: white;
        }
        
        .response-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 18px;
            font-weight: bold;
            color: black;
            z-index: 1000;
        }
    </style>
</head>
<body></body>
<script>

    // ===== EXPERIMENT VERSION =====
    const EXPERIMENT_VERSION = '20';
    console.log('====================================');
    console.log('Experiment Version:', EXPERIMENT_VERSION);
    console.log('====================================');
    // ==============================

    // ===== TEST MODE =====
    // Set to true to enable faster testing (0ms stimulus presentation)
    const TEST_MODE = true;
    // =====================

    // Initialize jsPsych
    const jsPsych = initJsPsych({
        on_finish: function() {
            // Add assigned trial type, participant ID, start time, SONA code, and version to all data rows
            jsPsych.data.get().addToAll({
                assigned_trial_type: assignedTrialType,
                participant_id: participantID,
                experiment_start_time: experimentStartTime,
                sona_survey_code: sonaSurveyCode,
                experiment_version: EXPERIMENT_VERSION
            });
            
            // Get all data as JSON for Google Sheets
            const allData = jsPsych.data.get().values();
            // Ensure all rows contain the primary expected keys (so Google Sheets headers include them even if first row lacks them)
            const requiredFields = [
                'assigned_trial_type', 'participant_id', 'experiment_start_time', 'sona_survey_code', 'experiment_version',
                'task', 'block', 'stimulus_name', 'stimulus_trial_type', 'question', 'secondary_question',
                'familiarity_rating', 'main_rating', 'similarity_rating', 'responded_on_time', 'reaction_time_ms', 'response_time_limit_ms',
                'check_question', 'check_answer', 'correct', 'timed_out'
            ];
            for (let row of allData) {
                for (let f of requiredFields) {
                    if (!(f in row)) {
                        row[f] = null;
                    }
                }
            }
            // Debug: Log data summary keys to verify fields present (e.g., main_rating)
            try {
                if (allData && allData.length) {
                    console.log('Total rows to send:', allData.length);
                    // Show the keys present in the last row and a sample of a rating row
                    const allKeys = Object.keys(allData[allData.length - 1]);
                    console.log('Keys in last data row:', allKeys);
                    const sampleRatingRow = [...allData].reverse().find(r => 'main_rating' in r || 'familiarity_rating' in r || 'similarity_rating' in r);
                    if (sampleRatingRow) {
                        console.log('Sample rating row found:', sampleRatingRow);
                    } else {
                        console.warn('No rating rows with main_rating/familiarity_rating/similarity_rating were found in data');
                    }
                } else {
                    console.warn('No data rows to send.');
                }
                } catch (e) {
                console.error('Error while inspecting data before sending:', e);
            }
            // Show a per-row presence/value for main_rating
            try {
                const mainRatingPresence = allData.map((r, i) => ({index: i, hasKey: Object.prototype.hasOwnProperty.call(r, 'main_rating'), value: r.main_rating}));
                console.log('main_rating presence/value per row (first 30 rows):', JSON.stringify(mainRatingPresence.slice(0, 30)));
            } catch (e) {
                console.warn('Could not compute main_rating presence list:', e);
            }
            
            // Send data to Google Sheets
            const googleSheetURL = 'https://script.google.com/macros/s/AKfycbyrOyKpRFHRUUpnRsNcsXDY4sc4p_zLFs2Zoahu-vEh_vVb8dUbe8Hp9EOOvf7T0bDe/exec';
            console.log('Sending data to Google Sheets...', allData.length, 'rows');
            // Additional diagnostics of the payload we are about to send
            try {
                const ratingRows = allData.filter(r => r.task === 'rating');
                const withMainKey = ratingRows.filter(r => Object.prototype.hasOwnProperty.call(r, 'main_rating'));
                const withMainValue = ratingRows.filter(r => r.main_rating !== null && r.main_rating !== undefined && r.main_rating !== '');
                console.log('Rating rows (task=="rating"):', ratingRows.length);
                console.log('Rating rows with main_rating key present (even if null):', withMainKey.length);
                console.log('Rating rows with non-empty main_rating:', withMainValue.length);
                if (withMainValue.length > 0) console.log('Example rating row with main_rating value:', JSON.stringify(withMainValue[0]));
                // Print a small payload sample (first 5 rows) so we can see exactly which keys are present
                const payloadSample = allData.slice(0, 5).map(r => {
                    const copy = {};
                    Object.keys(r).forEach(k => { copy[k] = r[k]; });
                    return copy;
                });
                console.log('Payload sample (first 5 rows):', JSON.stringify(payloadSample));
            } catch (e) {
                console.error('Error during payload diagnostics:', e);
            }
            
            // Use fetch with proper handling
            try {
                const jsonString = JSON.stringify(allData);
                console.log('Outgoing JSON payload length:', jsonString.length);
                // Also show the first 1000 chars so dev console shows content at a glance
                console.log('Outgoing JSON payload start:', jsonString.slice(0, 1000));
            } catch (e) {
                console.warn('Could not stringify entire payload:', e);
            }
            fetch(googleSheetURL, {
                method: 'POST',
                body: JSON.stringify(allData),
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                }
            }).then(function(response) {
                console.log('Google Sheets response status:', response.status);
                return response.text();
            }).then(function(text) {
                console.log('Google Sheets response:', text);
                
                // Redirect to SONA for credit if we have a valid survey code
                if (sonaSurveyCode && sonaSurveyCode !== 'NO_SONA_CODE') {
                    console.log('Redirecting to SONA for credit...');
                    const sonaRedirectUrl = SONA_COMPLETION_URL + sonaSurveyCode;
                    // Show brief message before redirect
                    alert('Thank you for completing the experiment! You will now be redirected to SONA to receive credit.');
                    window.location.href = sonaRedirectUrl;
                } else {
                    // No SONA code - regular completion
                    alert('Thank you for completing the experiment! Your data has been saved.');
                }
            }).catch(function(error) {
                console.error('Error sending data to Google Sheets:', error);
                
                // Even if data save failed, try to give SONA credit
                if (sonaSurveyCode && sonaSurveyCode !== 'NO_SONA_CODE') {
                    const proceed = confirm('Warning: There was an error saving your data. Do you want to continue to SONA for credit? (Click OK to continue, Cancel to stay on this page)');
                    if (proceed) {
                        const sonaRedirectUrl = SONA_COMPLETION_URL + sonaSurveyCode;
                        window.location.href = sonaRedirectUrl;
                    }
                } else {
                    alert('Warning: There was an error saving your data. Please contact the researcher.');
                }
            });
        }
    });

    // Timeline
    let timeline = [];
    
    // ===== SONA INTEGRATION =====
    // Extract SONA survey code from URL parameter (e.g., ?id=100179)
    const urlParams = new URLSearchParams(window.location.search);
    const sonaSurveyCode = urlParams.get('id') || 'NO_SONA_CODE';
    console.log('SONA Survey Code:', sonaSurveyCode);
    
    // SONA completion URL - Configured for UCSB SONA system
    // Format: https://ucsb.sona-systems.com/webstudy_credit.aspx?experiment_id=XXXX&credit_token=YYYY&survey_code=%SURVEY_CODE%
    // The survey code will be appended automatically from the URL parameter
    const SONA_COMPLETION_URL = 'https://ucsb.sona-systems.com/webstudy_credit.aspx?experiment_id=4667&credit_token=042f348276d14b4db26f57efe7356440&survey_code=';
    // ============================
    
    // Generate unique participant ID
    const participantID = 'P' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    console.log('Participant ID:', participantID);
    
    // Record experiment start time (human readable)
    const experimentStartTime = new Date().toLocaleString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    console.log('Experiment start time:', experimentStartTime);
    
    // Track familiar candidates to exclude from later blocks
    let familiarCandidates = [];
    
    // Track which trials have been used for memory checks in each block
    let memoryCheckUsed = {
        block1: new Set(),
        block2: new Set()
    };

    // Define the questions for the two blocks
    const questions = [
        {
            text: "How good do you think this person would be as a member of congress?",
            scale_labels: ["Not at all", "Very much"],
            secondaryQuestion: null  // Familiarity is always shown in block 1
        },
        {
            text: "In general, how likely would you be to vote for this person as a U.S. House Representative?",
            scale_labels: ["Not at all", "Very much"],
            secondaryQuestion: {
                text: "How similar do you consider yourself to this person in ideology, political views, and background?",
                scale_labels: ["Not at all", "Very much"],
                showForTypes: ["bio", "dual"]  // Only show for bio and dual conditions
            }
        }
    ];

    // Randomly assign participant to one of three trial type conditions
    const assignedTrialType = Math.floor(Math.random() * 3) + 1; // 1, 2, or 3
    console.log('Assigned trial type condition:', assignedTrialType);
    
    // Load CSV data and parse it
    let stimuli = [];
    let materialsLoaded = false;
    
    // Function to parse CSV (handles quoted fields with commas)
    function parseCSV(text) {
        // Remove BOM if present
        if (text.charCodeAt(0) === 0xFEFF) {
            text = text.slice(1);
        }
        // Split by \r\n or \n to handle both Windows and Unix line endings
        const lines = text.trim().split(/\r?\n/);
        const headers = parseCSVLine(lines[0]);
        const data = [];
        
        console.log('CSV Headers:', headers);
        
        for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            const row = {};
            for (let j = 0; j < headers.length; j++) {
                row[headers[j]] = values[j] ? values[j].trim() : '';
            }
            data.push(row);
        }
        return data;
    }
    
    // Function to parse a single CSV line (handles quoted fields)
    function parseCSVLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
                inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else {
                current += char;
            }
        }
        result.push(current); // Add the last field
        
        return result;
    }
    
    // Function to load materials from CSV
    async function loadMaterials() {
        try {
            const response = await fetch('materials.csv');
            const text = await response.text();
            const data = parseCSV(text);
            
            const trialTypeColumn = 'trial_type' + assignedTrialType;
            
            for (let row of data) {
                // Skip if exclude flag is set
                if (row.exclude === '1') continue;
                
                // Skip if no trial type assigned for this condition
                if (!row[trialTypeColumn]) continue;
                
                const imagePath = row.image_name;
                const bioPath = row.bio_name;
                const trialType = row[trialTypeColumn];
                const name = imagePath.replace('image/', '').replace(/\.(jpeg|jpg|png)/, '');
                
                stimuli.push({
                    image: imagePath,
                    bio: bioPath,
                    type: trialType,
                    name: name,
                    check_question: row.check_question,
                    check_answer: row.check_answer
                });
                
                // Log stimuli with memory check questions to verify parsing
                if (row.check_question && row.check_question.length > 0) {
                    console.log('Loaded memory check for', name, '- Question:', row.check_question, '- Correct answer:', row.check_answer, '- Type:', typeof row.check_answer, '- All row keys:', Object.keys(row));
                }
            }
            
            console.log('Loaded', stimuli.length, 'stimuli');
            materialsLoaded = true;
        } catch (error) {
            console.error('Error loading materials:', error);
        }
    }

    // Preload all images and bio files
    const images_to_preload = stimuli.map(s => s.image);
    
    // Object to store loaded bio texts
    const loadedBios = {};
    
    // Preload bio texts
    async function preloadBios() {
        for (let stim of stimuli) {
            if (stim.type === 'bio' || stim.type === 'dual') {
                loadedBios[stim.name] = await loadBioText(stim.bio);
            }
        }
    }
    
    const preload = {
        type: jsPsychPreload,
        images: images_to_preload
    };
    timeline.push(preload);

    // Welcome screen
    const welcome = {
        type: jsPsychInstructions,
        pages: [
            '<h2>Welcome to the Social Impression Rating Task</h2>' +
            '<p>In this experiment, you will see photos and/or biographies of candidate in the election for the U.S. House of Representatives.</p>' +
            '<p>Your task is to rate your impression of each person on different dimensions.</p>' +
            '<p></p>' +
            '<p><b>Before you begin, please ensure:</b></p>' +
            '<ul style="text-align: left; max-width: 500px; margin: 20px auto;">' +
            '<li>You are in a <b>quiet space</b> where you can focus without distractions</li>' +
            '<li>You are using a <b>computer</b> (not a mobile device or tablet)</li>' +
            '<li>You are using a <b>compatible browser</b> (Chrome, Safari, Firefox, or Edge recommended)</li>' +
            '<p>If you have any questions, please contact the researcher at psych-yeslab.study@ucsb.edu.</p>' +
            '</ul>' +
            '<p>Press the Next button to continue.</p>'
        ],
        show_clickable_nav: true
    };
    timeline.push(welcome);
    
    // Eligibility check
    const eligibility_check = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="max-width: 600px; margin: 100px auto; text-align: center;">' +
            '<h2>Eligibility Question</h2>' +
            '<p style="font-size: 18px; margin: 40px 0;">At present, do you have the legal right to vote in the U.S.?</p>' +
            '<div style="display: flex; justify-content: center; gap: 40px; margin-top: 40px;">' +
            '<button class="familiarity-button" style="padding: 20px 60px; font-size: 18px;" data-response="yes">Yes</button>' +
            '<button class="familiarity-button" style="padding: 20px 60px; font-size: 18px;" data-response="no">No</button>' +
            '</div>' +
            '<input type="hidden" id="eligibility-response" value="">' +
            '</div>',
        choices: "NO_KEYS",
        data: {
            task: 'eligibility_check'
        },
        on_load: function() {
            const trialObj = this;
            trialObj.eligibilityResponse = null;
            
            const buttons = document.querySelectorAll('[data-response]');
            const responseInput = document.getElementById('eligibility-response');
            
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const response = this.getAttribute('data-response');
                    responseInput.value = response;
                    trialObj.eligibilityResponse = response;
                    jsPsych.finishTrial();
                });
            });
        },
        on_finish: function(data) {
            data.eligible = this.eligibilityResponse;
            data.voting_eligible = this.eligibilityResponse === 'yes';
        }
    };
    timeline.push(eligibility_check);
    
    // End experiment if not eligible
    const ineligible_end = {
        timeline: [{
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div style="max-width: 600px; margin: 100px auto; text-align: center;">' +
                '<h2>Thank You</h2>' +
                '<p style="font-size: 18px; margin: 40px 0;">Thank you for your interest in this study.</p>' +
                '<p style="font-size: 18px;">Unfortunately, this study is only open to individuals who have the legal right to vote in the U.S.</p>' +
                '<p style="font-size: 16px; margin-top: 40px;">If you have any questions, please contact the researcher at psych-yeslab.study@ucsb.edu.</p>' +
                '<p style="font-size: 16px; margin-top: 40px;">You may close this window.</p>' +
                '</div>',
            choices: "NO_KEYS",
            data: {
                task: 'ineligible_end'
            }
        }],
        conditional_function: function() {
            const last_trial = jsPsych.data.get().last(1).values()[0];
            return !last_trial.voting_eligible;
        }
    };
    timeline.push(ineligible_end);
    
    // Instructions (only shown if eligible)
    const instructions = {
        timeline: [{
            type: jsPsychInstructions,
            pages: [
                '<h2>Task Structure</h2>' +
                '<p>The task consists of 2 blocks, each with different questions.</p>' +
                '<p>In each block, you will see multiple political candidates and rate them on multiple questions.</p>' +
                '<p>There are three types of trials:</p>' +
                '<ul style="text-align: left; max-width: 500px; margin: 20px auto;">' +
                '<li><b>Photo trials:</b> You will make judgments based solely on their profile photos</li>' +
                '<li><b>Bio trials:</b> You will make judgments based solely on their biographies</li>' +
                '<li><b>Dual trials:</b> You will make judgments based on both their photos and biographies</li>' +
                '</ul>' +
                '<p>Press the Next button to continue.</p>',
                
                '<h2>How to Respond</h2>' +
                '<p>After viewing the photo and/or biography for an amount of time, the rating scale will <b>appear</b> at the bottom of the screen.</p>' +
                '<p>You will see \"Now you can respond\" in the top left corner when you can start answering.</p>' +
                '<p></p>' +
                '<p><b>To enter your responses:</b></p>' +
                '<p>• For familiarity, click on the button that matches your answer. You can change your answer by clicking a different button.</p>' +
                '<p>• For other ratings, use your mouse or trackpad to move the <b>sliders</b> to indicate your ratings</p>' +
                '<p>• You can adjust your ratings before submitting</p>' +
                '<p>• Press <b>SPACEBAR</b> to submit your answers</p>' +
                '<p><b>Important:</b> Please do your best to make quick and legitimate responses, or you will see a warning.</p>' +
                '<p>There will be occasional <b>attention check questions</b> and <b>memory check questions</b> - please read carefully!</p>' +
                '<p>Press the Next button to begin.</p>'
            ],
            show_clickable_nav: true
        }],
        conditional_function: function() {
            const last_trial = jsPsych.data.get().last(2).values()[1];
            return last_trial.voting_eligible;
        }
    };
    timeline.push(instructions);

    // Function to format candidate name from filename format to display format
    function formatCandidateName(name) {
        // Convert "Adam_Frisch" to "Adam Frisch"
        return name.replace(/_/g, ' ');
    }
    
    // Function to load bio text
    async function loadBioText(bioPath) {
        try {
            const response = await fetch(bioPath);
            const text = await response.text();
            return text;
        } catch (error) {
            console.error('Error loading bio:', error);
            return 'Bio text not available';
        }
    }

    // Function to create a rating trial
    function createRatingTrial(stimulus, question, block_num) {
        const trial_type = stimulus.type;
        const presentation_time = TEST_MODE ? 0 : (trial_type === 'photo' ? 2000 : 10000);
        const response_time_limit = trial_type === 'photo' ? 20000 : 120000;
        
        let trial_sequence = [];
        
        // Add fixation cross before each trial
        const fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="fixation">+</div>',
            choices: "NO_KEYS",
            trial_duration: 500,
            data: {
                task: 'fixation',
                block: block_num
            }
        };
        trial_sequence.push(fixation);
        
        // Format candidate name for display
        const candidateName = formatCandidateName(stimulus.name);
        
        // Prepare stimulus content based on trial type
        let stimulusContent = '';
        if (trial_type === 'photo') {
            stimulusContent = '<img src="' + stimulus.image + '" class="stimulus-image">' +
                '<div class="candidate-name">' + candidateName + '</div>';
        } else if (trial_type === 'bio') {
            const bioText = loadedBios[stimulus.name] || 'Bio text not available';
            stimulusContent = '<div class="bio-text">' + bioText.replace(/\n/g, '<br>') + '</div>';
        } else if (trial_type === 'dual') {
            const bioText = loadedBios[stimulus.name] || 'Bio text not available';
            stimulusContent = '<div class="dual-container">' +
                '<img src="' + stimulus.image + '" class="stimulus-image">' +
                '<div class="candidate-name">' + candidateName + '</div>' +
                '<div class="bio-text">' + bioText.replace(/\n/g, '<br>') + '</div>' +
                '</div>';
        }
        
        // Combined stimulus + rating trial (presentation only, no sliders yet)
        const combined_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="stimulus-with-rating">' +
                '<div id="warning-container"></div>' +
                '<div class="stimulus-content">' +
                stimulusContent +
                '</div>' +
                '</div>',
            choices: "NO_KEYS",
            trial_duration: presentation_time,
            data: {
                task: 'stimulus_presentation',
                stimulus_name: stimulus.name,
                stimulus_trial_type: stimulus.type,
                block: block_num,
                question: question.text
            }
        };
        trial_sequence.push(combined_trial);
        
        // Rating response phase with sliders
        const rating_selection = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                // Only show familiarity question in first block (block_num === 1)
                let familiarityHTML = '';
                if (block_num === 1) {
                    familiarityHTML = '<div class="question-text" style="margin-top: 30px;">Before participating, how familiar were you with this person?</div>' +
                        '<div class="familiarity-buttons">' +
                        '<button class="familiarity-button" data-value="0">I do not know anything about this person</button>' +
                        '<button class="familiarity-button" data-value="1">I know who this person is or have heard about them</button>' +
                        '</div>' +
                        '<input type="hidden" id="familiarity-value" value="">';
                }
                
                // Check if we need to show secondary question (similarity)
                let secondaryQuestionHTML = '';
                console.log('Block:', block_num, 'Trial type:', trial_type, 'Question has secondary:', !!question.secondaryQuestion);
                if (question.secondaryQuestion) {
                    console.log('Secondary question showForTypes:', question.secondaryQuestion.showForTypes);
                    console.log('Includes trial_type?', question.secondaryQuestion.showForTypes.includes(trial_type));
                }
                if (question.secondaryQuestion && question.secondaryQuestion.showForTypes.includes(trial_type)) {
                    secondaryQuestionHTML = '<div class="question-text" style="margin-top: 40px;">' + question.secondaryQuestion.text + '</div>' +
                        '<div class="slider-wrapper">' +
                        '<input type="range" min="1" max="7" value="4" class="slider" id="secondary-slider">' +
                        '<span class="slider-value" id="secondary-value">4</span>' +
                        '</div>' +
                        '<div class="slider-labels">' +
                        '<span>' + question.secondaryQuestion.scale_labels[0] + '</span>' +
                        '<span>' + question.secondaryQuestion.scale_labels[1] + '</span>' +
                        '</div>';
                }
                
                return '<div class="stimulus-with-rating">' +
                    '<div class="response-indicator">Now you can respond</div>' +
                    '<div id="warning-container"></div>' +
                    stimulusContent +
                    '<div class="slider-container">' +
                    familiarityHTML +
                    '<div class="question-text" style="margin-top: 40px;">' + question.text + '</div>' +
                    '<div class="slider-wrapper">' +
                    '<input type="range" min="1" max="7" value="4" class="slider" id="main-slider">' +
                    '<span class="slider-value" id="main-value">4</span>' +
                    '</div>' +
                    '<div class="slider-labels">' +
                    '<span>' + question.scale_labels[0] + '</span>' +
                    '<span>' + question.scale_labels[1] + '</span>' +
                    '</div>' +
                    secondaryQuestionHTML +
                    '<div class="submit-prompt" id="submit-prompt" style="margin-top: 30px; font-size: 16px; font-style: italic;">Press SPACEBAR to submit your answers</div>' +
                    '</div>' +
                    '</div>';
            },
            choices: "NO_KEYS",
            data: {
                task: 'rating',
                stimulus_name: stimulus.name,
                stimulus_trial_type: stimulus.type,
                block: block_num,
                question: question.text,
                secondary_question: question.secondaryQuestion ? question.secondaryQuestion.text : null
            },
            on_load: function() {
                // Store current values on the trial object so they persist after DOM is cleared
                const trialObj = this;
                trialObj.currentFamiliarity = null;
                trialObj.currentMainRating = '4';  // default slider value
                trialObj.currentSecondaryRating = '4';  // default slider value
                
                // Track whether user actually interacted with controls
                trialObj.familiarityClicked = false;
                trialObj.mainSliderMoved = false;
                trialObj.secondarySliderMoved = false;
                
                // Get slider elements
                const familiarityButtons = document.querySelectorAll('.familiarity-button');
                const familiarityValue = document.getElementById('familiarity-value');
                const mainSlider = document.getElementById('main-slider');
                const mainValue = document.getElementById('main-value');
                const secondarySlider = document.getElementById('secondary-slider');
                const secondaryValue = document.getElementById('secondary-value');
                
                // Handle familiarity button clicks
                if (familiarityButtons.length > 0 && familiarityValue) {
                    familiarityButtons.forEach(button => {
                        button.addEventListener('click', function() {
                            // Remove selected class from all buttons
                            familiarityButtons.forEach(btn => btn.classList.remove('selected'));
                            // Add selected class to clicked button
                            this.classList.add('selected');
                            // Update hidden input value
                            const value = this.getAttribute('data-value');
                            familiarityValue.value = value;
                            // Store in trial object
                            trialObj.currentFamiliarity = value;
                            trialObj.familiarityClicked = true;
                        });
                    });
                }
                
                // Update display when sliders change
                if (mainSlider && mainValue) {
                    mainSlider.oninput = function() {
                        mainValue.textContent = this.value;
                        // Store in trial object
                        trialObj.currentMainRating = this.value;
                        trialObj.mainSliderMoved = true;
                    };
                }
                
                if (secondarySlider && secondaryValue) {
                    secondarySlider.oninput = function() {
                        secondaryValue.textContent = this.value;
                        // Store in trial object
                        trialObj.currentSecondaryRating = this.value;
                        trialObj.secondarySliderMoved = true;
                    };
                }
                
                // Record when the participant was allowed to respond (for RT calculation)
                trialObj.responseStartTime = performance.now();

                // Add spacebar handler with validation
                const spacebarHandler = function(e) {
                    if (e.key === ' ' || e.code === 'Space') {
                        e.preventDefault();
                        
                        // Validate responses
                        let validationErrors = [];
                        
                        // Check familiarity (only in block 1)
                        if (block_num === 1 && !trialObj.familiarityClicked) {
                            validationErrors.push('Please select your familiarity with this person');
                        }
                        
                        // Check main slider
                        if (!trialObj.mainSliderMoved) {
                            validationErrors.push('Please move the main rating slider. If your answer is neutral, please move the slider back to the center');
                        }
                        
                        // Check secondary slider (only if it exists)
                        if (secondarySlider && !trialObj.secondarySliderMoved) {
                            validationErrors.push('<br>Please move the similarity rating slider. If your answer is neutral, please move the slider back to the center');
                        }
                        
                        // If validation fails, show warning
                        if (validationErrors.length > 0) {
                            const warningDiv = document.getElementById('warning-container');
                            if (warningDiv) {
                                warningDiv.innerHTML = '<div class="validation-warning">' + validationErrors.join('. ') + '.</div>';
                                // Clear validation warning after 3 seconds
                                setTimeout(function() {
                                    if (warningDiv) {
                                        warningDiv.innerHTML = '';
                                    }
                                }, 3000);
                            }
                            return; // Don't proceed
                        }
                        
                        // If validation passes, end trial with data
                        document.removeEventListener('keydown', spacebarHandler);
                        
                        // Create data object to pass to finishTrial (include plugin metadata and computed RT)
                        const trialData = {
                            task: 'rating',
                            stimulus_name: stimulus.name,
                            stimulus_trial_type: stimulus.type,
                            block: block_num,
                            question: question.text,
                            secondary_question: question.secondaryQuestion ? question.secondaryQuestion.text : null,
                            familiarity_rating: trialObj.currentFamiliarity,
                            familiarity_clicked: trialObj.familiarityClicked,
                            main_rating: trialObj.currentMainRating,
                            main_slider_moved: trialObj.mainSliderMoved,
                            similarity_rating: secondarySlider ? trialObj.currentSecondaryRating : null,
                            similarity_slider_moved: trialObj.secondarySliderMoved,
                            // compute RT since finishTrial is called programmatically
                            rt: Math.round(performance.now() - trialObj.responseStartTime)
                        };
                        
                        console.log('Submitting rating trial data:', trialData);
                        jsPsych.finishTrial(trialData);
                    }
                };
                document.addEventListener('keydown', spacebarHandler);
                
                // Show warning after response_time_limit
                const warningTimeout = setTimeout(function() {
                    const warningDiv = document.getElementById('warning-container');
                    if (warningDiv && jsPsych.getCurrentTrial().type !== null) {
                        warningDiv.innerHTML = '<div class="warning-message">Please respond faster!</div>';
                    }
                }, response_time_limit);
                
                // Store timeout and handler for cleanup
                this.warningTimeout = warningTimeout;
                this.spacebarHandler = spacebarHandler;
            },
            on_finish: function(data) {
                // Data is now passed from finishTrial, but also set from trial object as backup
                // Use 'in' checks to allow '0' and other falsy values
                if (!('familiarity_rating' in data) || data.familiarity_rating === null) {
                    data.familiarity_rating = this.currentFamiliarity;
                }
                if (!('main_rating' in data) || data.main_rating === null) {
                    data.main_rating = this.currentMainRating;
                }
                if (!('similarity_rating' in data) || data.similarity_rating === null) {
                    data.similarity_rating = this.currentSecondaryRating;
                }

                // Debug: log rating data for each rating trial (helps verify ratings are recorded)
                console.log('Rating trial data:', {
                    stimulus_name: data.stimulus_name,
                    block: data.block,
                    familiarity_rating: data.familiarity_rating,
                    main_rating: data.main_rating,
                    similarity_rating: data.similarity_rating,
                    rt: data.rt
                });
                
                data.responded_on_time = data.rt !== null && data.rt <= response_time_limit;
                data.reaction_time_ms = data.rt;
                data.response_time_limit_ms = response_time_limit;
                
                // Track familiar candidates in block 1 to exclude from later blocks
                if (block_num === 1 && data.familiarity_rating === '1') {
                    familiarCandidates.push(stimulus.name);
                    console.log('Added familiar candidate:', stimulus.name, '- Total familiar:', familiarCandidates.length);
                }
                
                // Clean up timeout and event listener
                if (this.warningTimeout) {
                    clearTimeout(this.warningTimeout);
                }
                if (this.spacebarHandler) {
                    document.removeEventListener('keydown', this.spacebarHandler);
                }
            }
        };
        trial_sequence.push(rating_selection);
        
        return {
            timeline: trial_sequence
        };
    }

    // Function to create attention check trial
    function createAttentionCheck(correct_key, block_num) {
        // Fixation before attention check
        const fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="fixation">+</div>',
            choices: "NO_KEYS",
            trial_duration: 500,
            data: {
                task: 'fixation',
                block: block_num
            }
        };
        
        const attention_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="attention-check">' +
                '<p><b>Attention Check:</b></p>' +
                '<p>To ensure you are paying attention, please press the number <b>' + correct_key + '</b> on your keyboard.</p>' +
                '</div>',
            choices: ['1', '2', '3', '4', '5', '6', '7'],
            data: {
                task: 'attention_check',
                correct_response: correct_key,
                block: block_num,
                stimulus_name: null,
                stimulus_trial_type: null
            },
            on_finish: function(data) {
                data.correct = data.response === correct_key;
                data.reaction_time_ms = data.rt;
            }
        };
        
        const feedback = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                const last_trial = jsPsych.data.get().last(1).values()[0];
                if (!last_trial.correct) {
                    return '<div style="display: flex; justify-content: center; align-items: center; height: 100vh;">' +
                        '<div class="warning-message">Wrong answer! Please pay attention to the task.</div>' +
                        '</div>';
                }
                return '';
            },
            choices: "NO_KEYS",
            trial_duration: function() {
                const last_trial = jsPsych.data.get().last(1).values()[0];
                return last_trial.correct ? 0 : 2000;
            },
            data: {
                task: 'attention_check_feedback',
                block: block_num
            }
        };
        
        return {
            timeline: [fixation, attention_trial, feedback]
        };
    }

    // Function to create memory check trial
    function createMemoryCheck(stimulus, block_num) {
        // Fixation before memory check
        const fixation = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="fixation">+</div>',
            choices: "NO_KEYS",
            trial_duration: 500,
            data: {
                task: 'fixation',
                block: block_num
            }
        };
        
        const memory_trial = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<div class="attention-check">' +
                '<p><b>Memory Check:</b></p>' +
                '<p>' + stimulus.check_question + '</p>' +
                '<div style="margin-top: 30px; display: flex; justify-content: center; gap: 40px;">' +
                '<button class="familiarity-button" style="padding: 20px 60px; font-size: 18px;" data-response="1">Yes</button>' +
                '<button class="familiarity-button" style="padding: 20px 60px; font-size: 18px;" data-response="0">No</button>' +
                '</div>' +
                '<input type="hidden" id="memory-response" value="">' +
                '</div>',
            choices: "NO_KEYS",
            trial_duration: 10000,
            data: {
                task: 'memory_check',
                stimulus_name: stimulus.name,
                stimulus_trial_type: stimulus.type,
                correct_answer: stimulus.check_answer,
                check_question: stimulus.check_question,
                block: block_num
            },
            on_load: function() {
                // Store response on trial object
                const trialObj = this;
                trialObj.memoryResponse = null;
                
                const buttons = document.querySelectorAll('[data-response]');
                const responseInput = document.getElementById('memory-response');
                
                buttons.forEach(button => {
                    button.addEventListener('click', function() {
                        const response = this.getAttribute('data-response');
                        responseInput.value = response;
                        // Store in trial object
                        trialObj.memoryResponse = response;
                        jsPsych.finishTrial();
                    });
                });
            },
            on_finish: function(data) {
                // Get response from trial object
                data.response = this.memoryResponse;
                // Convert to strings for comparison since CSV values are strings
                data.correct = data.response === String(data.correct_answer);
                data.timed_out = data.response === null || data.response === '';
                data.reaction_time_ms = data.rt;
                console.log('Memory check - Question:', stimulus.check_question, 
                           '| Response:', data.response, '| Correct answer:', data.correct_answer, 
                           '| Is correct:', data.correct);
            }
        };
        
        const feedback = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function() {
                const last_trial = jsPsych.data.get().last(1).values()[0];
                if (last_trial.timed_out) {
                    return '<div style="display: flex; justify-content: center; align-items: center; height: 100vh;">' +
                        '<div style="color: red; font-size: 18px; font-weight: bold; text-align: center;">Too slow! Please respond faster to memory check questions.</div>' +
                        '</div>';
                } else if (!last_trial.correct) {
                    return '<div style="display: flex; justify-content: center; align-items: center; height: 100vh;">' +
                        '<div style="color: red; font-size: 18px; font-weight: bold; text-align: center;">Wrong answer! Please pay attention to the biography content.</div>' +
                        '</div>';
                } else {
                    return '<div style="display: flex; justify-content: center; align-items: center; height: 100vh;">' +
                        '<div style="color: green; font-size: 18px; font-weight: bold; text-align: center;">Your answer is correct. Great job paying attention!</div>' +
                        '</div>';
                }
            },
            choices: "NO_KEYS",
            trial_duration: function() {
                const last_trial = jsPsych.data.get().last(1).values()[0];
                return (last_trial.timed_out || !last_trial.correct) ? 2000 : 1500;
            },
            data: {
                task: 'memory_check_feedback',
                block: block_num
            }
        };
        
        return {
            timeline: [fixation, memory_trial, feedback]
        };
    }

    // Function to build a single block
    function buildBlock(block, pushToTimeline = true) {
        // Block instructions
        let instructionText = '<h2>Block ' + (block + 1) + ' of 2</h2>';
        
        if (block === 0) {
            // Block 1: mention both familiarity and main question
            instructionText += '<p>For this block, you will answer the following questions:</p>' +
                '<p style="font-size: 18px; font-weight: bold; margin: 20px;">1. Familiarity: Before participating, how familiar were you with this person?</p>' +
                '<p style="font-size: 18px; font-weight: bold; margin: 20px;">2. ' + questions[block].text + '</p>' +
                '<p>Press the spacebar to begin.</p>';
        } else {
            // Block 2: show main question and secondary question (similarity for bio/dual trials)
            instructionText += '<p>For this block, you will answer the following question(s):</p>' +
                '<p style="font-size: 18px; font-weight: bold; margin: 20px;">1. ' + questions[block].text + '</p>' +
                '<p style="font-size: 18px; font-weight: bold; margin: 20px;">2. ' + questions[block].secondaryQuestion.text + '</p>' +
                '<p>Note: You only need to answer one question in some trials, while in others you will answer both.</p>' +
                '<p>Press the spacebar to begin.</p>';
        }
        
        const block_instructions = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: instructionText,
            choices: [' ']
        };
        
        // Create a local timeline for this block
        const blockTimeline = [];
        blockTimeline.push(block_instructions);
        
        // Filter stimuli based on block
        let available_stimuli;
        if (block === 0) {
            // Block 1: use all stimuli
            available_stimuli = [...stimuli];
            console.log('Block 1: Using all', available_stimuli.length, 'stimuli');
        } else {
            // Block 2: filter out familiar candidates
            console.log('Block 2: Familiar candidates to filter:', familiarCandidates);
            available_stimuli = stimuli.filter(s => !familiarCandidates.includes(s.name));
            console.log('Block 2: Filtering out', familiarCandidates.length, 'familiar candidates');
            console.log('Block 2: Using', available_stimuli.length, 'stimuli');
            console.log('Block 2: Available stimulus names:', available_stimuli.map(s => s.name));
        }
        
        // Group by trial type
        const photoTrials = jsPsych.randomization.shuffle(available_stimuli.filter(s => s.type === 'photo'));
        const bioTrials = jsPsych.randomization.shuffle(available_stimuli.filter(s => s.type === 'bio'));
        const dualTrials = jsPsych.randomization.shuffle(available_stimuli.filter(s => s.type === 'dual'));
        
        // Shuffle the order of the three groups for this block
        const trialGroups = jsPsych.randomization.shuffle([
            {name: 'photo', trials: photoTrials},
            {name: 'bio', trials: bioTrials},
            {name: 'dual', trials: dualTrials}
        ]);
        
        // Concatenate in the shuffled order
        const block_stimuli = [];
        trialGroups.forEach(group => {
            block_stimuli.push(...group.trials);
        });
        console.log('Block', block + 1, 'trial order:', trialGroups.map(g => g.name).join(' -> '));
        
        // Select bio and dual trials that have memory check questions
        const bioDualTrials = block_stimuli.filter(s => 
            (s.type === 'bio' || s.type === 'dual') && s.check_question && s.check_question.length > 0
        );
        
        // Get the memory check tracking set for this block
        const currentBlockMemorySet = block === 0 ? memoryCheckUsed.block1 : memoryCheckUsed.block2;
        
        // Filter out trials already used for memory checks in this block
        const availableForMemoryCheck = bioDualTrials.filter(s => !currentBlockMemorySet.has(s.name));
        
        // Calculate 10% (rounded up) of available bio/dual trials for memory checks
        const numMemoryChecks = Math.ceil(availableForMemoryCheck.length * 0.1);
        const memoryCheckTrials = jsPsych.randomization.sampleWithoutReplacement(availableForMemoryCheck, Math.min(numMemoryChecks, availableForMemoryCheck.length));
        
        // Mark these trials as used for memory checks in this block
        memoryCheckTrials.forEach(t => currentBlockMemorySet.add(t.name));
        
        const memoryCheckNames = new Set(memoryCheckTrials.map(t => t.name));
        
        console.log('Block', block + 1, '- Total bio/dual trials:', bioDualTrials.length, 
                    '- Available for memory check:', availableForMemoryCheck.length,
                    '- Memory checks:', memoryCheckTrials.length,
                    '- Selected:', Array.from(memoryCheckNames));
        
        // Calculate number of attention checks (10% of trials, at least 1)
        const num_attention_checks = Math.max(1, Math.round(block_stimuli.length * 0.1));
        
        // Create array of trial indices and randomly select positions for attention checks
        let trial_indices = Array.from({length: block_stimuli.length}, (_, i) => i);
        let attention_check_positions = jsPsych.randomization.sampleWithoutReplacement(trial_indices, num_attention_checks);
        
        // Add rating trials with randomly inserted attention checks
        for (let i = 0; i < block_stimuli.length; i++) {
            blockTimeline.push(createRatingTrial(block_stimuli[i], questions[block], block + 1));
            
            // Add memory check if this trial was selected for memory check
            if (memoryCheckNames.has(block_stimuli[i].name)) {
                blockTimeline.push(createMemoryCheck(block_stimuli[i], block + 1));
            }
            
            // Add attention check if this position was selected
            if (attention_check_positions.includes(i)) {
                const random_key = String(Math.floor(Math.random() * 7) + 1);
                blockTimeline.push(createAttentionCheck(random_key, block + 1));
            }
        }
        
        // Either push to main timeline or return the block timeline
        if (pushToTimeline) {
            blockTimeline.forEach(t => timeline.push(t));
        }
        return blockTimeline;
    }

    // Function to build the experimental blocks
    function buildBlocks() {
        // Build Block 1
        buildBlock(0);
        
        // Add break screen
        const break_screen = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<h2>Break</h2>' +
                '<p>You have completed block 1 of 2.</p>' +
                '<p>Take a short break if needed.</p>' +
                '<p>Press the spacebar when you are ready to continue.</p>',
            choices: [' '],
            on_finish: function() {
                console.log('Block 1 complete. Familiar candidates:', familiarCandidates.length, '-', familiarCandidates);
                
                // TEST MODE: If no familiar candidates, simulate some for testing Block 2 filtering
                if (TEST_MODE && familiarCandidates.length === 0) {
                    console.log('TEST MODE: Simulating familiar candidates');
                    const testFamiliar = jsPsych.randomization.sampleWithoutReplacement(
                        stimuli.map(s => s.name), 
                        Math.min(3, stimuli.length)
                    );
                    familiarCandidates.push(...testFamiliar);
                    console.log('TEST MODE: Marked as familiar:', familiarCandidates);
                }
                
                // Build Block 2 now and add to timeline
                console.log('Building Block 2 now with familiar candidates filtered out...');
                const block2Timeline = buildBlock(1, false);

                // Insert Block 2 trials into the timeline right after this trial
                console.log('Inserting', block2Timeline.length, 'Block 2 trials after current index');

                // Add each trial from Block 2
                block2Timeline.forEach(trial => {
                    jsPsych.addNodeToEndOfTimeline(trial);
                });

                // After we add Block 2 trials, append the final screen so it appears last
                console.log('Appending final screen after Block 2');
                jsPsych.addNodeToEndOfTimeline(final_screen);
            }
        };
        timeline.push(break_screen);
        
        // Define final screen (will be added after Block 2 is inserted)
        const final_screen = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: '<h2>Thank you!</h2>' +
                '<p>You have completed the experiment.</p>' +
                '<p>Your data has been saved and will download automatically.</p>' +
                '<p>If you have any questions, please contact the researcher at psych-yeslab.study@ucsb.edu.</p>' +
                '<p>Press any key to finish.</p>',
            choices: "ALL_KEYS"
        };
        // NOTE: Do not push the final_screen yet. We'll append it after building Block 2
        //       inside the break screen's on_finish so the final screen appears last.
    }

    // Load materials, preload bios, build blocks, then run the experiment
    loadMaterials().then(() => {
        console.log('Materials loaded. Stimuli count:', stimuli.length);
        return preloadBios();
    }).then(() => {
        console.log('Bios preloaded');
        buildBlocks();
        console.log('Blocks built. Timeline length:', timeline.length);
        console.log('Starting experiment...');
        jsPsych.run(timeline);
    }).catch((error) => {
        console.error('Error during experiment setup:', error);
        alert('Error loading experiment: ' + error.message);
    });

</script>
</html>
